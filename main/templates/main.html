{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Cihuy United - Products & News</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<div class="bg-[#181f2a] min-h-screen pt-24 pb-10">
  <div class="max-w-[1100px] mx-auto px-4">

    <!-- Header -->
    <header class="mb-8 text-center sm:text-left">
      <h1 class="text-3xl font-bold text-[#90caf9]">Cihuy United</h1>
      <p class="text-[#b0bec5]">Stay updated with the latest football Gear</p>
    </header>
    <button onclick="showModal()" 
        class="inline-flex items-center px-4 py-2 bg-[#16a34a] text-white font-semibold rounded-md hover:bg-[#15803d] focus:ring-2 focus:ring-[#90caf9] transition-all duration-200 mb-4">
        Create Product by AJAX
    </button>

    <!-- Filter -->
    <section class="flex flex-wrap items-center justify-between mb-8 bg-[#232b3e] rounded-xl border border-[#374151] p-5">
      <div class="flex gap-3">
        <a href="?"
           class="px-5 py-2 rounded-md font-medium transition 
           {% if request.GET.filter == 'all' or not request.GET.filter %}
              bg-[#43a047] text-white
           {% else %}
              bg-[#1a2233] text-[#b0bec5] border border-[#374151]
           {% endif %}">
          All Products
        </a>
        <a href="?filter=my"
           class="px-5 py-2 rounded-md font-medium transition
           {% if request.GET.filter == 'my' %}
              bg-[#43a047] text-white
           {% else %}
              bg-[#1a2233] text-[#b0bec5] border border-[#374151]
           {% endif %}">
          My Products
        </a>
      </div>

      {% if user.is_authenticated %}
      <div class="text-[#b0bec5] text-sm mt-3 sm:mt-0">
        Last login: {{ last_login }}
      </div>
      {% endif %}
    </section>

    <!-- Products -->
    <section class="bg-[#232b3e] rounded-2xl p-8 shadow-lg mb-12">
      <!-- Info Aplikasi -->
      <div class="mb-6 text-[#b0bec5] space-x-6">
        <span>Nama Aplikasi: <b class="text-white">{{ nama_aplikasi }}</b></span>
        <span>NPM: <b class="text-white">{{ npm }}</b></span>
        <span>Name: <b class="text-white">{{ name }}</b></span>
        <span>Class: <b class="text-white">{{ class }}</b></span>
      </div>

      <hr class="border-t border-[#374151] my-6">

      <div class="flex justify-between items-center mb-5">
        <h2 class="text-2xl text-[#90caf9] font-semibold">Products</h2>
        <a href="{% url 'main:create_product' %}">
          <button class="bg-[#1976d2] hover:bg-[#1565c0] text-white px-5 py-2 rounded-md font-semibold transition">
            + Add Product
          </button>
        </a>
      </div>

      {% if not products %}
      <!-- Empty State -->
      <div class="bg-[#1a2233] rounded-xl p-10 text-center text-[#b0bec5]">
        <img src="{% static 'image/no-news.png' %}" alt="No products" class="w-28 mx-auto mb-4">
        <h3 class="text-white text-xl mb-2">No products found</h3>
        <p class="mb-4">Be the first to add a product to Cihuy United.</p>
        <a href="{% url 'main:create_product' %}">
          <button class="bg-[#43a047] hover:bg-[#388e3c] text-white px-5 py-2 rounded-md font-semibold transition">
            Create Product
          </button>
        </a>
      </div>
      {% else %}
      <!-- Products Grid -->
      <div class="grid gap-6 grid-cols-[repeat(auto-fit,minmax(270px,1fr))]">
        {% for product in products %}
        <div class="bg-[#1a2233] rounded-xl p-5 shadow-md flex flex-col">
          <a href="{% url 'main:show_product' product.id %}" class="no-underline">
            <h3 class="text-white text-lg font-semibold mb-2 hover:text-[#90caf9] transition">
              {{ product.name }}
            </h3>
          </a>

          <p class="mb-3 text-sm flex items-center flex-wrap gap-2 text-[#b0bec5]">
            <span class="bg-[#374151] text-[#90caf9] px-2 py-0.5 rounded-md">{{ product.category }}</span>
            {% if product.is_featured %}
              <span class="bg-[#ffe082] text-[#d17b00] px-2 py-0.5 rounded-md">★ Featured</span>
            {% endif %}

            <span class="text-xs text-[#90caf9] italic">
              {{ product.created_at|date:"d M Y H:i" }}
            </span>

            <!-- Views badge -->
            <span class="bg-[#1a2233] border border-[#374151] text-[#b0bec5] px-2 py-0.5 rounded-md flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-[#90caf9]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 
                  7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
              </svg>
              {{ product.views }}
            </span>
          </p>

          {% if product.thumbnail %}
          <img src="{{ product.thumbnail }}" alt="thumbnail" class="rounded-md w-full h-[160px] object-cover mb-3">
          {% endif %}

          <div class="text-[#90caf9] font-bold text-lg mb-1">Rp {{ product.price|floatformat:0 }}</div>
          <div class="text-[#b0bec5] text-sm mb-3">Stock: {{ product.stock }}</div>

          <p class="text-[#b0bec5] text-sm flex-grow">{{ product.description|truncatewords:25 }}...</p>

          <div class="mt-4 flex flex-wrap gap-2">
            <a href="{% url 'main:show_product' product.id %}">
              <button class="bg-[#1976d2] hover:bg-[#1565c0] text-white px-4 py-1.5 rounded-md font-medium transition">
                Read More
              </button>
            </a>

            {% if user.is_authenticated and product.user == user %}
            <a href="{% url 'main:edit_product' product.pk %}">
              <button class="bg-[#43a047] hover:bg-[#388e3c] text-white px-4 py-1.5 rounded-md font-medium transition">
                Edit
              </button>
            </a>
            <a href="{% url 'main:delete_product' product.pk %}" onclick="return confirm('Are you sure you want to delete this product?');">
              <button class="bg-[#e53935] hover:bg-[#c62828] text-white px-4 py-1.5 rounded-md font-medium transition">
                Delete
              </button>
            </a>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </section>

    <!-- Optional More Products -->
    {% if products_list is defined %}
    <section class="bg-[#232b3e] rounded-2xl p-8 shadow-lg mb-12">
      <div class="flex justify-between items-center mb-5">
        <h2 class="text-2xl text-[#90caf9] font-semibold">More Products</h2>
        <a href="{% url 'main:create_product' %}">
          <button class="bg-[#43a047] hover:bg-[#388e3c] text-white px-5 py-2 rounded-md font-semibold transition">
            + Create Product
          </button>
        </a>
      </div>
      {% if not products_list %}
      <div class="bg-[#1a2233] rounded-xl p-10 text-center text-[#b0bec5]">
        <img src="{% static 'image/no-news.png' %}" alt="No products" class="w-28 mx-auto mb-4">
        <h3 class="text-white text-xl mb-2">No products found</h3>
        <p class="mb-4">Be the first to share a product with the community.</p>
        <a href="{% url 'main:create_product' %}">
          <button class="bg-[#43a047] hover:bg-[#388e3c] text-white px-5 py-2 rounded-md font-semibold transition">
            Create Product
          </button>
        </a>
      </div>
      {% else %}
      <div class="grid gap-6 grid-cols-[repeat(auto-fit,minmax(270px,1fr))]">
        {% for product in products_list %}
          {% include 'card_product.html' with product=product %}
        {% endfor %}
      </div>
      {% endif %}
    </section>
    {% endif %}

    <p class="text-center text-[#789] mt-10">© 2025 Cihuy United</p>

  </div>
</div>
<!-- Loading State -->
<div id="loading" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
  <svg class="animate-spin h-8 w-8 text-green-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
  </svg>
  <p class="text-gray-600 mt-3">Loading products...</p>
</div>

<!-- Error State -->
<div id="error" class="hidden"></div>

<!-- Product Grid -->
<div id="grid" class="hidden"></div>

<!-- Empty State -->
<div id="empty" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
  <div class="w-32 h-32 mx-auto mb-4">
    <img src="{% static 'image/no-product.png' %}" alt="No products available" class="w-full h-full object-contain">
  </div>
  <h3 class="text-lg font-medium text-gray-900 mb-2">No products found</h3>
  <p class="text-gray-500 mb-6">Be the first to add a product to the catalog.</p>
  <a href="{% url 'main:create_product' %}" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
    Add Product
  </a>
</div>

<script>
const PRODUCT_API_ENDPOINT = "{% url 'main:show_json' %}";
const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";

const loadingSpinner = document.getElementById('loading');
const errorMessage = document.getElementById('error');
const emptyStateDisplay = document.getElementById('empty');
const productGridContainer = document.getElementById('grid');
const showAllProductsButton = document.getElementById('filter-all');
const showMyProductsButton = document.getElementById('filter-my');

let activeFilter = 'all';
let allProductData = [];

function updateFilterButtonsAppearance() {
  if (!showAllProductsButton || !showMyProductsButton) return;
  
  if (activeFilter === 'all') {
    showAllProductsButton.className = 'bg-green-600 text-white px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-700';
    showMyProductsButton.className = 'bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-600 hover:text-white';
  } else {
    showMyProductsButton.className = 'bg-green-600 text-white px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-700';
    showAllProductsButton.className = 'bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-600 hover:text-white';
  }
}

function displayPageSection({ showLoading = false, showError = false, showEmpty = false, showGrid = false }) {
  loadingSpinner.classList.toggle('hidden', !showLoading);
  errorMessage.classList.toggle('hidden', !showError);
  emptyStateDisplay.classList.toggle('hidden', !showEmpty);
  productGridContainer.classList.toggle('hidden', !showGrid);
  
  if (showGrid) {
    productGridContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
  }
}

function getReadableCategoryName(categoryCode) {
  const categoryMapping = {
    hockey: 'Hockey',
    skating: 'Skating',
    curling: 'Curling',
    soccer: 'Soccer',
    other: 'Other',
  };
  return categoryMapping[categoryCode] || categoryCode;
}

function buildProductCardElement(item) {
  const article = document.createElement('article');
  article.className = 'bg-white rounded-lg border border-gray-200 hover:shadow-lg transition-shadow duration-300 overflow-hidden flex flex-col h-full';

  // 🔗 Link detail, edit, delete
  const linkDetail = `{% url 'main:show_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.id);
  const linkEdit = `{% url 'main:edit_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.id);
  const linkDelete = `{% url 'main:delete_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.id);

  // 🧼 Sanitasi data
  const name = DOMPurify.sanitize(item.name);
  const description = DOMPurify.sanitize(item.description);
  const category = DOMPurify.sanitize(item.category);
  const price = DOMPurify.sanitize(item.price);
  const stock = DOMPurify.sanitize(item.stock);
  const thumbnail = DOMPurify.sanitize(item.thumbnail);
  const createdAt = DOMPurify.sanitize(
    new Date(item.created_at).toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric' 
    })
  );

  // 🏷️ Label kategori dan fitur
  const categoryLabel = DOMPurify.sanitize(getCategoryLabel(category));
  const isFeatured = item.is_featured;
  const featuredLabel = isFeatured 
    ? DOMPurify.sanitize(`<span class='inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800'>Featured</span>`) 
    : '';

  // 🧑‍💻 Tombol edit dan delete hanya untuk pemilik
  const editDeleteHtml = CURRENT_USER_ID && Number(CURRENT_USER_ID) === Number(item.user_id)
    ? `<div class='flex space-x-2'>
        <a href='${linkEdit}' class='text-gray-600 hover:text-gray-700 text-sm transition-colors'>Edit</a>
        <a href='${linkDelete}' class='text-red-600 hover:text-red-700 text-sm transition-colors' onclick='return confirm("Are you sure you want to delete this product?")'>Delete</a>
      </div>`
    : '';

  // 🖼️ Thumbnail
  const thumbnailHtml = DOMPurify.sanitize(
    item.thumbnail 
      ? `<img src='${thumbnail}' alt='${name}' class='w-full h-full object-cover'>`
      : `<div class='w-full h-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center text-gray-400'>No Image</div>`
  );

  // 🧩 Isi kartu produk
  const cardHtml = `
    <div class="aspect-[16/9] relative overflow-hidden">
      ${thumbnailHtml}
      <div class="absolute top-3 left-3">
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-green-600 text-white">${categoryLabel}</span>
      </div>
      <div class="absolute top-3 right-3 flex space-x-2">
        ${featuredLabel}
      </div>
    </div>
    <div class="p-5 flex flex-col flex-1">
      <div class="flex items-center text-sm text-gray-500 mb-3">
        <time>${createdAt}</time>
        <span class="mx-2">•</span>
        <span>${stock} in stock</span>
      </div>
      <h3 class="text-lg font-semibold text-gray-900 mb-3 line-clamp-2 leading-tight">
        <a href="${linkDetail}" class="hover:text-green-600 transition-colors">${name}</a>
      </h3>
      <p class="text-gray-600 text-sm leading-relaxed line-clamp-3 mb-4">${description}</p>
      <div class="flex items-center justify-between mt-auto pt-4 border-t border-gray-100">
        <span class="text-green-700 font-semibold text-sm">$${price}</span>
        ${editDeleteHtml}
      </div>
    </div>
  `;

  article.innerHTML = cardHtml;
  return article;
}

function getCategoryLabel(categoryCode) {
  const categories = {
    'shoes': 'Shoes',
    'jersey': 'Jersey',
    'accessories': 'Accessories',
    'keychain': 'Key Chain',
    'bag': 'Bag',
    'ball': 'Ball',
    'gloves': 'Gloves',
    'hat': 'Hat',
    'watch': 'Watch',
    'scarf': 'Scarf',
    'socks': 'Socks',
    'water_bottle': 'Water Bottle',
    'poster': 'Poster',
    'magazine': 'Magazine',
    'sticker': 'Sticker',
    'others': 'Others',
  };
  return categories[categoryCode] || 'Uncategorized';
}


function renderAllProducts(products) {
  productGridContainer.innerHTML = '';
  products.forEach(product => {
    const card = buildProductCardElement(product);
    productGridContainer.appendChild(card);
  });
}

function filterAndDisplayProducts() {
  updateFilterButtonsAppearance();
  
  const filtered = activeFilter === 'all'
    ? allProductData
    : allProductData.filter(p => Number(p.user_id) === Number(CURRENT_USER_ID));

  if (filtered.length === 0) {
    displayPageSection({ showEmpty: true });
  } else {
    renderAllProducts(filtered);
    displayPageSection({ showGrid: true });
  }
}

async function fetchProducts() {
  try {
    displayPageSection({ showLoading: true });
    
    const res = await fetch(PRODUCT_API_ENDPOINT, { headers: { 'Accept': 'application/json' } });
    if (!res.ok) throw new Error('Failed to fetch products');
    
    const data = await res.json();
    allProductData = data || [];
    
    filterAndDisplayProducts();
  } catch (err) {
    console.error('Error loading products:', err);
    displayPageSection({ showError: true });
  }
}

function initProductPage() {
  if (showAllProductsButton) showAllProductsButton.addEventListener('click', () => { activeFilter = 'all'; filterAndDisplayProducts(); });
  if (showMyProductsButton) showMyProductsButton.addEventListener('click', () => { activeFilter = 'my'; filterAndDisplayProducts(); });
  
  fetchProducts();
}

initProductPage();

document.addEventListener('productAdded', function() {
    // Refresh data without page reload
    fetchProducts();
});
</script>

{% endblock content %}
