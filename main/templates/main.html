{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Cihuy United - Products</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<div class="bg-[#181f2a] min-h-screen pt-24 pb-10">
  <div class="max-w-[1100px] mx-auto px-4">

    <!-- Header -->
    <header class="mb-8 text-center sm:text-left">
      <h1 class="text-3xl font-bold text-[#90caf9]">Cihuy United</h1>
      <p class="text-[#b0bec5]">Stay updated with the latest football Gear</p>
    </header>
    <button onclick="showCreateModal()"
        class="inline-flex items-center px-4 py-2 bg-[#16a34a] text-white font-semibold rounded-md hover:bg-[#15803d] focus:ring-2 focus:ring-[#90caf9] transition-all duration-200 mb-4">
        Create Product
    </button>

    <!-- Filter -->
    <section class="flex flex-wrap items-center justify-between mb-8 bg-[#232b3e] rounded-xl border border-[#374151] p-5">
      <div class="flex gap-3">
        <a href="?"
           class="px-5 py-2 rounded-md font-medium transition 
           {% if request.GET.filter == 'all' or not request.GET.filter %}
              bg-[#43a047] text-white
           {% else %}
              bg-[#1a2233] text-[#b0bec5] border border-[#374151]
           {% endif %}">
          All Products
        </a>
        <a href="?filter=my"
           class="px-5 py-2 rounded-md font-medium transition
           {% if request.GET.filter == 'my' %}
              bg-[#43a047] text-white
           {% else %}
              bg-[#1a2233] text-[#b0bec5] border border-[#374151]
           {% endif %}">
          My Products
        </a>
      </div>

      {% if user.is_authenticated %}
      <div class="text-[#b0bec5] text-sm mt-3 sm:mt-0">
        Last login: {{ last_login }}
      </div>
      {% endif %}
    </section>

    <!-- Products -->
    <section class="bg-[#232b3e] rounded-2xl p-8 shadow-lg mb-12">
      <!-- Info Aplikasi -->
      <div class="mb-6 text-[#b0bec5] space-x-6">
        <span>Nama Aplikasi: <b class="text-white">{{ nama_aplikasi }}</b></span>
        <span>NPM: <b class="text-white">{{ npm }}</b></span>
        <span>Name: <b class="text-white">{{ name }}</b></span>
        <span>Class: <b class="text-white">{{ class }}</b></span>
      </div>

      <hr class="border-t border-[#374151] my-6">

      <div class="flex justify-between items-center mb-5">
        <h2 class="text-2xl text-[#90caf9] font-semibold">Products</h2>
        <a href="{% url 'main:create_product' %}">
        </a>
      </div>

      {% if not products %}
      <!-- Empty State -->
      <div class="bg-[#1a2233] rounded-xl p-10 text-center text-[#b0bec5]">
        <img src="{% static 'image/no-news.png' %}" alt="No products" class="w-28 mx-auto mb-4">
        <h3 class="text-white text-xl mb-2">No products found</h3>
        <p class="mb-4">Be the first to add a product to Cihuy United.</p>
        <a href="{% url 'main:create_product' %}">
          <button class="bg-[#43a047] hover:bg-[#388e3c] text-white px-5 py-2 rounded-md font-semibold transition">
            Add More Product
          </button>
        </a>
      </div>
      {% else %}
      <!-- Products Grid -->
      <div class="grid gap-6 grid-cols-[repeat(auto-fit,minmax(270px,1fr))]">
        {% for product in products %}
        <div class="bg-[#1a2233] rounded-xl p-5 shadow-md flex flex-col">
          <a href="{% url 'main:show_product' product.id %}" class="no-underline">
            <h3 class="text-white text-lg font-semibold mb-2 hover:text-[#90caf9] transition">
              {{ product.name }}
            </h3>
          </a>

          <p class="mb-3 text-sm flex items-center flex-wrap gap-2 text-[#b0bec5]">
            <span class="bg-[#374151] text-[#90caf9] px-2 py-0.5 rounded-md">{{ product.category_id }}</span>
            {% if product.is_featured %}
              <span class="bg-[#ffe082] text-[#d17b00] px-2 py-0.5 rounded-md">‚òÖ Featured</span>
            {% endif %}

            <span class="text-xs text-[#90caf9] italic">
              {{ product.created_at|date:"d M Y H:i" }}
            </span>

            <!-- Views badge -->
            <span class="bg-[#1a2233] border border-[#374151] text-[#b0bec5] px-2 py-0.5 rounded-md flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-[#90caf9]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 
                  7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
              </svg>
              {{ product.views }}
            </span>
          </p>

          {% if product.thumbnail %}
          <img src="{{ product.thumbnail }}" alt="thumbnail" class="rounded-md w-full h-[160px] object-cover mb-3">
          {% endif %}

          <div class="text-[#90caf9] font-bold text-lg mb-1">Rp {{ product.price|floatformat:0 }}</div>
          <div class="text-[#b0bec5] text-sm mb-3">Stock: {{ product.stock }}</div>

          <p class="text-[#b0bec5] text-sm flex-grow">{{ product.description|truncatewords:25 }}...</p>

          <div class="mt-4 flex flex-wrap gap-2">
            <a href="{% url 'main:show_product' product.id %}">
              <button class="bg-[#1976d2] hover:bg-[#1565c0] text-white px-4 py-1.5 rounded-md font-medium transition">
                Read More
              </button>
            </a>

            {% if user.is_authenticated and product.user == user %}
            <button onclick="showEditModal('{{ product.id }}')" class="bg-[#43a047] hover:bg-[#388e3c] text-white px-4 py-1.5 rounded-md font-medium transition">
              Edit
            </button>
            <button onclick="deleteProduct('{{ product.id }}')" class="bg-[#e53935] hover:bg-[#c62828] text-white px-4 py-1.5 rounded-md font-medium transition">
              Delete
            </button>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </section>

    <!-- Optional More Products -->
    {% if products_list is defined %}
    <section class="bg-[#232b3e] rounded-2xl p-8 shadow-lg mb-12">
      <div class="flex justify-between items-center mb-5">
        <h2 class="text-2xl text-[#90caf9] font-semibold">More Products</h2>
        <a href="{% url 'main:create_product' %}">
          <button class="bg-[#43a047] hover:bg-[#388e3c] text-white px-5 py-2 rounded-md font-semibold transition">
            + Add More Products
          </button>
        </a>
      </div>
      {% if not products_list %}
      <div class="bg-[#1a2233] rounded-xl p-10 text-center text-[#b0bec5]">
        <img src="{% static 'image/no-news.png' %}" alt="No products" class="w-28 mx-auto mb-4">
        <h3 class="text-white text-xl mb-2">No products found</h3>
        <p class="mb-4">Be the first to share a product with the community.</p>
        <a href="{% url 'main:create_product' %}">
          <button class="bg-[#43a047] hover:bg-[#388e3c] text-white px-5 py-2 rounded-md font-semibold transition">
            + Create Product
          </button>
        </a>
      </div>
      {% else %}
      <div class="grid gap-6 grid-cols-[repeat(auto-fit,minmax(270px,1fr))]">
        {% for product in products_list %}
          {% include 'card_product.html' with product=product %}
        {% endfor %}
      </div>
      {% endif %}
    </section>
    {% endif %}

    <p class="text-center text-[#789] mt-10">¬© 2025 Cihuy United</p>

  </div>
</div>

<!-- Modal for Create/Edit Product -->
<div id="productModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-[#232b3e] border border-[#374151] rounded-2xl shadow-xl p-8 w-full max-w-lg mx-4">
    <div class="text-center mb-8">
      <h1 id="modalTitle" class="text-3xl font-bold text-[#90caf9]">‚ûï Add Product</h1>
      <p class="text-gray-300 text-sm mt-2">Fill in the product details below</p>
    </div>

    <form id="productForm" class="space-y-6">
      {% csrf_token %}
      <input type="hidden" id="productId" name="product_id">

      <div class="bg-[#1a2233] border border-[#374151] rounded-lg p-4">
        <label class="block text-gray-200 font-semibold mb-1">Product Name</label>
        <input type="text" id="name" name="name" class="w-full px-4 py-2 rounded-md bg-[#0f172a] text-white border border-[#374151] focus:outline-none focus:ring-2 focus:ring-[#90caf9]" required>
      </div>

      <div class="bg-[#1a2233] border border-[#374151] rounded-lg p-4">
        <label class="block text-gray-200 font-semibold mb-1">Category</label>
        <select id="category" name="category" class="w-full px-3 py-2 rounded-md bg-[#0f172a] text-white border border-[#374151] focus:outline-none focus:ring-2 focus:ring-[#90caf9]" required>
          <option value="shoes">Shoes</option>
          <option value="jersey">Jersey</option>
          <option value="accessories">Accessories</option>
          <option value="keychain">Key Chain</option>
          <option value="bag">Bag</option>
          <option value="ball">Ball</option>
          <option value="gloves">Gloves</option>
          <option value="hat">Hat</option>
          <option value="watch">Watch</option>
          <option value="scarf">Scarf</option>
          <option value="socks">Socks</option>
          <option value="water_bottle">Water Bottle</option>
          <option value="poster">Poster</option>
          <option value="magazine">Magazine</option>
          <option value="sticker">Sticker</option>
          <option value="others">Others</option>
        </select>
      </div>

      <div class="bg-[#1a2233] border border-[#374151] rounded-lg p-4">
        <label class="block text-gray-200 font-semibold mb-1">Price</label>
        <input type="number" id="price" name="price" class="w-full px-3 py-2 rounded-md bg-[#0f172a] text-white border border-[#374151] focus:outline-none focus:ring-2 focus:ring-[#90caf9]" required>
      </div>

      <div class="bg-[#1a2233] border border-[#374151] rounded-lg p-4">
        <label class="block text-gray-200 font-semibold mb-1">Stock</label>
        <input type="number" id="stock" name="stock" class="w-full px-3 py-2 rounded-md bg-[#0f172a] text-white border border-[#374151] focus:outline-none focus:ring-2 focus:ring-[#90caf9]" required>
      </div>

      <div class="bg-[#1a2233] border border-[#374151] rounded-lg p-4">
        <label class="block text-gray-200 font-semibold mb-1">Description</label>
        <textarea id="description" name="description" rows="4" class="w-full px-3 py-2 rounded-md bg-[#0f172a] text-white border border-[#374151] focus:outline-none focus:ring-2 focus:ring-[#90caf9]" required></textarea>
      </div>

      <div class="bg-[#1a2233] border border-[#374151] rounded-lg p-4">
        <label class="block text-gray-200 font-semibold mb-1">Thumbnail URL</label>
        <input type="url" id="thumbnail" name="thumbnail" class="w-full px-3 py-2 bg-[#1a2233] border border-[#374151] rounded-md text-gray-200 focus:outline-none focus:ring-2 focus:ring-[#90caf9]">
      </div>

      <div class="bg-[#1a2233] border border-[#374151] rounded-lg p-4">
        <label class="flex items-center">
          <input type="checkbox" id="is_featured" name="is_featured" class="mr-2">
          <span class="text-gray-200 font-semibold">Featured Product</span>
        </label>
      </div>

      <div class="flex gap-4">
        <button type="submit" class="w-full bg-[#1976d2] hover:bg-[#1565c0] text-white font-semibold py-3 rounded-lg shadow-md transition duration-300">
          Save Product
        </button>
        <button type="button" onclick="closeModal()" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 rounded-lg shadow-md transition duration-300">
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Loading State -->
<div id="loading" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
  <svg class="animate-spin h-8 w-8 text-green-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
  </svg>
  <p class="text-gray-600 mt-3">Loading products...</p>
</div>

<!-- Error State -->
<div id="error" class="hidden"></div>

<!-- Product Grid -->
<div id="grid" class="hidden"></div>
<script>
const PRODUCT_API_ENDPOINT = "{% url 'main:show_json' %}";
const CREATE_PRODUCT_URL = "{% url 'main:add_product_entry_ajax' %}";
const EDIT_PRODUCT_URL_BASE = "/main/edit-product-ajax/";
const DELETE_PRODUCT_URL_BASE = "/main/delete-product-ajax/";
const PRODUCT_JSON_URL_BASE = "/main/json/";
const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";

const loadingSpinner = document.getElementById('loading');
const errorMessage = document.getElementById('error');
const emptyStateDisplay = document.getElementById('empty');
const productGridContainer = document.getElementById('grid');
const showAllProductsButton = document.getElementById('filter-all');
const showMyProductsButton = document.getElementById('filter-my');

let activeFilter = 'all';
let allProductData = [];

function updateFilterButtonsAppearance() {
  if (!showAllProductsButton || !showMyProductsButton) return;
  
  if (activeFilter === 'all') {
    showAllProductsButton.className = 'bg-green-600 text-white px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-700';
    showMyProductsButton.className = 'bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-600 hover:text-white';
  } else {
    showMyProductsButton.className = 'bg-green-600 text-white px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-700';
    showAllProductsButton.className = 'bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-600 hover:text-white';
  }
}

function displayPageSection({ showLoading = false, showError = false, showEmpty = false, showGrid = false }) {
  loadingSpinner.classList.toggle('hidden', !showLoading);
  errorMessage.classList.toggle('hidden', !showError);
  emptyStateDisplay.classList.toggle('hidden', !showEmpty);
  productGridContainer.classList.toggle('hidden', !showGrid);
  
  if (showGrid) {
    productGridContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
  }
}

function getReadableCategoryName(categoryCode) {
  const categoryMapping = {
    hockey: 'Hockey',
    skating: 'Skating',
    curling: 'Curling',
    soccer: 'Soccer',
    other: 'Other',
  };
  return categoryMapping[categoryCode] || categoryCode;
}

function buildProductCardElement(item) {
  const article = document.createElement('article');
  article.className = 'bg-white rounded-lg border border-gray-200 hover:shadow-lg transition-shadow duration-300 overflow-hidden flex flex-col h-full';

  // üîó Link detail, edit, delete
  const linkDetail = `{% url 'main:show_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.id);
  const linkEdit = `{% url 'main:edit_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.id);
  const linkDelete = `{% url 'main:delete_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.id);

  // üßº Sanitasi data
  const name = DOMPurify.sanitize(item.name);
  const description = DOMPurify.sanitize(item.description);
  const category = DOMPurify.sanitize(item.category);
  const price = DOMPurify.sanitize(item.price);
  const stock = DOMPurify.sanitize(item.stock);
  const thumbnail = DOMPurify.sanitize(item.thumbnail);
  const createdAt = DOMPurify.sanitize(
    new Date(item.created_at).toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric' 
    })
  );

  // üè∑Ô∏è Label kategori dan fitur
  const categoryLabel = DOMPurify.sanitize(getCategoryLabel(category));
  const isFeatured = item.is_featured;
  const featuredLabel = isFeatured 
    ? DOMPurify.sanitize(`<span class='inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800'>Featured</span>`) 
    : '';

  // üßë‚Äçüíª Tombol edit dan delete hanya untuk pemilik
  const editDeleteHtml = CURRENT_USER_ID && Number(CURRENT_USER_ID) === Number(item.user_id)
    ? `<div class='flex space-x-2'>
        <a href='${linkEdit}' class='text-gray-600 hover:text-gray-700 text-sm transition-colors'>Edit</a>
        <a href='${linkDelete}' class='text-red-600 hover:text-red-700 text-sm transition-colors' onclick='return confirm("Are you sure you want to delete this product?")'>Delete</a>
      </div>`
    : '';

  // üñºÔ∏è Thumbnail
  const thumbnailHtml = DOMPurify.sanitize(
    item.thumbnail 
      ? `<img src='${thumbnail}' alt='${name}' class='w-full h-full object-cover'>`
      : `<div class='w-full h-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center text-gray-400'>No Image</div>`
  );

  // üß© Isi kartu produk
  const cardHtml = `
    <div class="aspect-[16/9] relative overflow-hidden">
      ${thumbnailHtml}
      <div class="absolute top-3 left-3">
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-green-600 text-white">${categoryLabel}</span>
      </div>
      <div class="absolute top-3 right-3 flex space-x-2">
        ${featuredLabel}
      </div>
    </div>
    <div class="p-5 flex flex-col flex-1">
      <div class="flex items-center text-sm text-gray-500 mb-3">
        <time>${createdAt}</time>
        <span class="mx-2">‚Ä¢</span>
        <span>${stock} in stock</span>
      </div>
      <h3 class="text-lg font-semibold text-gray-900 mb-3 line-clamp-2 leading-tight">
        <a href="${linkDetail}" class="hover:text-green-600 transition-colors">${name}</a>
      </h3>
      <p class="text-gray-600 text-sm leading-relaxed line-clamp-3 mb-4">${description}</p>
      <div class="flex items-center justify-between mt-auto pt-4 border-t border-gray-100">
        <span class="text-green-700 font-semibold text-sm">$${price}</span>
        ${editDeleteHtml}
      </div>
    </div>
  `;

  article.innerHTML = cardHtml;
  return article;
}

function getCategoryLabel(categoryCode) {
  const categories = {
    'shoes': 'Shoes',
    'jersey': 'Jersey',
    'accessories': 'Accessories',
    'keychain': 'Key Chain',
    'bag': 'Bag',
    'ball': 'Ball',
    'gloves': 'Gloves',
    'hat': 'Hat',
    'watch': 'Watch',
    'scarf': 'Scarf',
    'socks': 'Socks',
    'water_bottle': 'Water Bottle',
    'poster': 'Poster',
    'magazine': 'Magazine',
    'sticker': 'Sticker',
    'others': 'Others',
  };
  return categories[categoryCode] || 'Uncategorized';
}


function renderAllProducts(products) {
  productGridContainer.innerHTML = '';
  products.forEach(product => {
    const card = buildProductCardElement(product);
    productGridContainer.appendChild(card);
  });
}

function filterAndDisplayProducts() {
  updateFilterButtonsAppearance();
  
  const filtered = activeFilter === 'all'
    ? allProductData
    : allProductData.filter(p => Number(p.user_id) === Number(CURRENT_USER_ID));

  if (filtered.length === 0) {
    displayPageSection({ showEmpty: true });
  } else {
    renderAllProducts(filtered);
    displayPageSection({ showGrid: true });
  }
}

async function fetchProducts() {
  try {
    displayPageSection({ showLoading: true });
    
    const res = await fetch(PRODUCT_API_ENDPOINT, { headers: { 'Accept': 'application/json' } });
    if (!res.ok) throw new Error('Failed to fetch products');
    
    const data = await res.json();
    allProductData = data || [];
    
    filterAndDisplayProducts();
  } catch (err) {
    console.error('Error loading products:', err);
    displayPageSection({ showError: true });
  }
}

function initProductPage() {
  if (showAllProductsButton) showAllProductsButton.addEventListener('click', () => { activeFilter = 'all'; filterAndDisplayProducts(); });
  if (showMyProductsButton) showMyProductsButton.addEventListener('click', () => { activeFilter = 'my'; filterAndDisplayProducts(); });
  
  fetchProducts();
}

initProductPage();

document.addEventListener('productAdded', function() {
    // Refresh data without page reload
    fetchProducts();
});

// Modal functions
function showCreateModal() {
    document.getElementById('modalTitle').textContent = '‚ûï Add Product';
    document.getElementById('productId').value = '';
    document.getElementById('productForm').reset();
    document.getElementById('productModal').classList.remove('hidden');
}

function showEditModal(productId) {
    document.getElementById('modalTitle').textContent = '‚úèÔ∏è Edit Product';
    document.getElementById('productId').value = productId;
    // Fetch product data and populate form
    const url = PRODUCT_JSON_URL_BASE + productId;
    fetch(url)
        .then(response => response.json())
        .then(data => {
            document.getElementById('name').value = data.name;
            document.getElementById('category').value = data.category;
            document.getElementById('price').value = data.price;
            document.getElementById('stock').value = data.stock;
            document.getElementById('description').value = data.description;
            document.getElementById('thumbnail').value = data.thumbnail || '';
            document.getElementById('is_featured').checked = data.is_featured;
        });
    document.getElementById('productModal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('productModal').classList.add('hidden');
}

// Handle form submission
document.getElementById('productForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const productId = formData.get('product_id');
    const url = productId ? EDIT_PRODUCT_URL_BASE + productId : CREATE_PRODUCT_URL;
    const method = 'POST';

    fetch(url, {
        method: method,
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.text())
    .then(data => {
        if (data === 'CREATED' || data === 'UPDATED') {
            closeModal();
            fetchProducts(); // Refresh the product list
        } else {
            alert('Error: ' + data);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
    });
});

// Delete product
function deleteProduct(productId) {
    if (confirm('Are you sure you want to delete this product?')) {
        const url = DELETE_PRODUCT_URL_BASE + productId;
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.text())
        .then(data => {
            if (data === 'DELETED') {
                fetchProducts(); // Refresh the product list
            } else {
                alert('Error: ' + data);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred');
        });
    }
}
</script>

{% endblock content %}
